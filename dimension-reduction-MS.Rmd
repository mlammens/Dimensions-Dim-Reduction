---
title: "Dealing with multi-collinearity when examining trait x environment relationships"
author: |
  - name: "Matthew E. Aiello-Lammens"
  - name: "Xiaojing Wang"
  - name: "Kent Holsinger"
utput: html_document
---

```{r file-settings, include=FALSE }
## Set package options
#knitr::opts_knit$set( root.dir = "../" )
knitr::opts_chunk$set( message=FALSE, warning=FALSE, fig.width = 6.5, fig.height = 6.5, echo=FALSE )
```


```{r, include=FALSE}
## Source setup script
source( "dim_reduce_setup.R" )
## Load data
load( "Preliminary.RData" )

library( knitr )
```

# Introduction

Ecological patterns and processes are influenced by multiple factors. Mutiple 
regressioncmethods are one way to account for many factors simultaneously. 
However, colinearity among factors (or predictor variables), while potentially 
important for understanding biological responses of species, can result in 
difficult model interpretations. This is because colinearity can result in 
incorrect model fits, in accurate estimates of regression coefficients, and 
unstable model results. In this paper we use a recent method developed by 
Curtis and Ghosh (@Curtis2007) to examine trait by environment relationships, 
where we simulated species trait values using environmental conditions of 
occurrences of species in two clades located in the Cape Floristic Region (CFR)
of South Africa.

# Objective

We examine the effectiveness of recently developed variable
selection algorithms using simulated and real data. Our ultimate goal is to 
determine the environmental variables that are most important in shaping
plant functional trait distribution patters in the Cape Floristic Region.
Using simulated data, we 
know *a priori* the functional relationships between environmental conditions 
and trait values. Because we are interested in understanding the effects of 
multi-collinearity on the accuracy of the Curtis and Ghosh method, in 
simulating our new trait, we purposely used a small number of environmental 
variables that were highly correlated with other environmental variables. 
After showing the effectiveness of these methods on simulated data, and 
determining the bounds of signal to noise relationships that yield accurate
results, we apply these methods to three datasets of plant functional traits
collected in the CFR. 

# Methods

Our study region is the Cape Floristic Region of South Africa, a region characterized
by high alpha and beta taxonomic diversity (REF), as well as high endemism. Functional
trait data were collected over multiple years at multiple locations. A previous analysis
of a subset of these data (@Mitchell2014) has suggested that ...

That earlier analysis differed from the present in that the underlying model was multi-factor,
multi-response, where as the present analysis is only multi-response. However, the present
analysis aims to examine the effects of many more predictor variables than was either 
computationally feasible, or interpretable, in the previous analysis.

We collected values for multiple environmental conditions for all sampling locations using
two primary sources of data Schulze (@Schulze2007) and Wilson and Silander (@Wilson2014). 
These values are primarily related to climatic conditions. We collected greater than ten
variables, which is much greater than in the previous analysis (@Mitchel2014)



## Environmental variables

We are working with 15 different environmental variables: 

Environmental variable | Symbol
-----------------------|-------
Consecutive drought days | CDD 
Consecutive frost days | CFD
Consecutive summer days | CSU
Growing degree days | GDD
Mean annual precipitation | MAP
Mean monthly precipitation in July | MMP.07 
Mean monthly precipitation in January | MMP.01 
Mean annual temperature | MAT
Minimum monthly temperature for July | MTmin.07 
Maximum monthly temperature for January | MTmax.01
Number of days with >2 mm rain | rr2
Average rainfall amount for wet days | sdii (simple daily intensity index)
Ratio of summer and winter rainfall (i.e., seasonality) | ratio 
Elevation | elevation
Solar insulation | insulation 

Many of these variables
are highly correlated with each other, as is evident from the 
correlation plot below.

```{r corr_plot, echo = FALSE, fig.height=20, fig.width=20}
corrplot.mixed( prot_pel_env_cor, upper = "ellipse" )
```

Looking at the correlation values, we find that the following variables
are highly **positively correlated ( > 0.8)**:

* CSU - MTmax.01
* GDD - MTmin.07
* GDD - MAT
* MAP - rr2
* MAP - sdii
* MAP - MMP.07
* rr2 - sdii
* rr2 - MMP.07
* sdii - MMP.07
* MTmax.01 - MAT

And the following are highly **negatively correlated ( < -0.8 )**

* CDD - rr2
* CFD - GDD
* CFD - MTmin.07
* GDD - Elevation
* MTmin.07 - Elevation

# Simulatated trait values

Based on the correlation analysis results, we chose to make our 
**simulated trait a function of MMP.07, MTmin.07, and Elevation**.
The functional form is:

$$
\text{Simulated trait} = \boldsymbol\beta * \boldsymbol X + \boldsymbol\epsilon
$$

where $\boldsymbol \beta$ is vector of environmental variable coefficients, 
$\boldsymbol X$ is a matrix of observed environmental variable values, and
$\boldsymbol \epsilon$ is a vector of random noise values with $\mu = 0$ and 
$\sigma^2$ varied from $0, ..., 1$ by increments of $0.1$. 

We used three different sets of values for 
$\beta_{MMP.07}$, $\beta_{MTmin.07}$, and $\beta_{Elevation}$.

1. $\beta_{MMP.07} = \beta_{MTmin.07} = \beta_{Elevation} = 0.8$ 
2. $\beta_{MMP.07} = 0.8$, $\beta_{MTmin.07} = 0.5$, $\beta_{Elevation} = 0.2$ 
3. $\beta_{MMP.07} = 0.8$, $\beta_{MTmin.07} = \beta_{Elevation} = 0.2$ 

while all other $\beta$ values $=0$ in each scenario.


When calculating the new trait values, we used only the environmental conditions
for the `r sum( prot_pel_df$genus == "Protea")` *Protea* observations,
which came from `r length( unique( prot_pel_df$Site_location ) )` different locations.
In the figure below, we plot the simulated trait value versus each of the
15 environmental conditions (rows) for 11 different $sigma^2$ values (columns), 
for simulation scenario (1) above (i.e., three equal $\beta$ values). 
Plots include a linear regression fit line (blue).

```{r trait_fig, echo=FALSE, message=FALSE, fig.height=20, fig.width=20}
sim_trait_m <- melt( sim_trait_df, measure.vars = clim_vars, 
                     value.name = "env.val", variable.name = "env.var" )

sim_trait_m <- melt( sim_trait_m, measure.vars = sim_trait_names, 
                     value.name = "sim.trait", variable.name = "sim.noise" )

## Look at only the simulations where all three coef = 0.8
sim_trait_m_temp <- filter( sim_trait_m, grepl( pattern = "3eq", sim.noise ) )
sim_trait_m_temp$sim.noise <- 
  sub( pattern = "_3eq", replacement = "", sim_trait_m_temp$sim.noise )

ggplot( data = sim_trait_m_temp,
        aes( x = env.val, y = sim.trait ) ) +
  geom_point() +
  stat_smooth( method = "lm" ) +
  facet_grid( env.var ~ sim.noise ) +
  xlab( "Environmental variable value" ) +
  ylab( "Simulated trait value" ) +
  theme_bw()

```

# Application of Curtis and Ghosh 2011 method

We applied the JAGS model to the simulated trait for a number of the 
different noise values. Considering the variable noise values and the
three coefficient scenarios, we explore multiple different signal
to noise ratios (SNR). The possible SNR values
are presented in the table below.

**Table 1.** Signal to noise ratio (SNR) values for each coefficient value
under various noise scenarios. Here, SNR is calculated as the *a priori* set
coefficient value divided by the *a priori* set noise (standard deviation) 
value.

```{r}
coef_vals <- c( 0.8, 0.5, 0.2 )

SNR <- as.data.frame( t( coef_vals %*% t( 1/noise_vect[-1] ) ) )
names( SNR ) <- paste0("Signal_", coef_vals)

SNR$Noise <- noise_vect[-1]

SNR <- SNR[ c( "Noise", "Signal_0.2", "Signal_0.5", "Signal_0.8" ) ]

kable( SNR, digits = 2 )

```

# Results

Below are histograms of CG results for various simulations. Also included
are the number of non 0s for each coefficient (i.e., the number of times
a variable was selected).

**Model Notes:**

We used the following JAGS parameters: 2 chains, iterations = 36,250, 
burn-in = 5,000, and thinning = 25. Once values are compiled, the result
is 2500 coefficient values for each environmental variable.

## Coefficients = 0.8, Noise = 0.5

```{r echo=FALSE, message=FALSE, fig.height=14, fig.width=14 }
beta_temp <- sim_fit$sim_trait_noise_0.5_3eq$BUGSoutput$sims.list$beta
beta_temp <- as.data.frame( beta_temp )
names( beta_temp ) <- clim_vars

ggplot() + 
  geom_boxplot( data = melt( beta_temp ), aes( x = variable, y = value ) ) +
  xlab( "Environmental variable" ) +
  ylab( "Regression coefficient value" ) +
  theme_bw()


nonzero_tbl <- apply( beta_temp, MARGIN = 2, FUN = function(x){ sum( x != 0 ) } )
nonzero_tbl <- as.data.frame( t( nonzero_tbl ) )

```

## Coefficients = 0.8 and 0.2, Noise = 0.5

```{r echo=FALSE, message=FALSE, fig.height=14, fig.width=14 }
beta_temp <- sim_fit$sim_trait_noise_0.5_2eq$BUGSoutput$sims.list$beta
beta_temp <- as.data.frame( beta_temp )
names( beta_temp ) <- clim_vars

ggplot() + 
  geom_boxplot( data = melt( beta_temp ), aes( x = variable, y = value ) ) +
  xlab( "Environmental variable" ) +
  ylab( "Regression coefficient value" ) +
  theme_bw()

nonzero_tbl <- rbind( nonzero_tbl, apply( beta_temp, MARGIN = 2, FUN = function(x){ sum( x != 0 ) } ) )

```

## Coefficients = 0.8, Noise = 2

```{r echo=FALSE, message=FALSE, fig.height=14, fig.width=14 }
beta_temp <- sim_fit$sim_trait_noise_2_3eq$BUGSoutput$sims.list$beta
beta_temp <- as.data.frame( beta_temp )
names( beta_temp ) <- clim_vars

ggplot() + 
  geom_boxplot( data = melt( beta_temp ), aes( x = variable, y = value ) ) +
  xlab( "Environmental variable" ) +
  ylab( "Regression coefficient value" ) +
  theme_bw()

nonzero_tbl <- rbind( nonzero_tbl, apply( beta_temp, MARGIN = 2, FUN = function(x){ sum( x != 0 ) } ) )


```

## Coefficients = 0.8, 0.5, and 0.2, Noise = 0.5

```{r echo=FALSE, message=FALSE, fig.height=14, fig.width=14 }
beta_temp <- sim_fit$sim_trait_noise_0.5_noeq$BUGSoutput$sims.list$beta
beta_temp <- as.data.frame( beta_temp )
names( beta_temp ) <- clim_vars

ggplot() + 
  geom_boxplot( data = melt( beta_temp ), aes( x = variable, y = value ) ) +
  xlab( "Environmental variable" ) +
  ylab( "Regression coefficient value" ) +
  theme_bw()

nonzero_tbl <- rbind( nonzero_tbl, apply( beta_temp, MARGIN = 2, FUN = function(x){ sum( x != 0 ) } ) )


```

```{r format_tble}
noise <- c( 0.5, 0.5, 2.0, 0.5 )
MMP.07_sig <- c( 0.8, 0.8, 0.8, 0.8 )
MTmin.07_sig <- c( 0.8, 0.2, 0.8, 0.5 )
Elevation_sig <- c( 0.8, 0.2, 0.8, 0.2 )

nonzero_tbl <- cbind( noise, MMP.07_sig, MTmin.07_sig, Elevation_sig, nonzero_tbl )

kable( nonzero_tbl )

```

# Thoughts

* The Curtis and Ghosh method appears to return relatively appropriate values
for the regression coefficients, which I am a little surprised by given the 
high correlation values between the predictor variables. 
